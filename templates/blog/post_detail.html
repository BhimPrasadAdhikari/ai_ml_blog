{% extends 'blog/base.html' %}
{% load static %}
{% load blog_extras %}

{% block title %}{{ post.title }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'blog/css/post_detail.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/comments.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<button id="focus-mode-toggle" class="focus-btn" title="Toggle Focus Mode">
    <i class="fas fa-expand"></i> <span>Focus Mode</span>
</button>

<div class="container-max">
    
    <div id="annotation-form" class="annotation-form-popup" style="display: none;">
        <h4>Add Annotation</h4>
        <div id="selected-text" class="selected-text-preview"></div>
        <textarea id="annotation-content" placeholder="Your insight..."></textarea>
        <div class="form-check">
            <input type="checkbox" id="annotation-public">
            <label for="annotation-public">Make Public?</label>
        </div>
        <div class="annotation-actions">
            <button id="submit-annotation" class="btn btn-sm btn-primary">Save</button>
            <button id="cancel-annotation" class="btn btn-sm btn-secondary">Cancel</button>
        </div>
    </div>

    <header class="post-header">
        <div class="header-meta">
            <span class="post-cat">
                {% for cat in post.categories.all|slice:":1" %}{{ cat.name }}{% endfor %}
            </span>
            <span class="read-time">{{ post.read_time|default:"5" }} min read</span>
            <div class="post-rating-display" title="Average Rating: {{ post.get_average_rating|floatformat:1 }}">
                <i class="fas fa-star"></i> <span>{{ post.get_average_rating|floatformat:1 }}</span>
                <span class="rating-count">({{ post.get_rating_count }})</span>
            </div>
        </div>
        
        <h1 class="post-title">{{ post.title }}</h1>
        
        <div class="author-meta-row">
            <a href="{% url 'profile_detail' username=post.author.username %}" class="author-chip">
                {% if post.author.profile.profile_picture %}
                    <img src="{{ post.author.profile.profile_picture.url }}" alt="{{ post.author.username }}">
                {% else %}
                    <div class="avatar-placeholder">{{ post.author.username|first|upper }}</div>
                {% endif %}
                <div class="author-text">
                    <span class="name">{{ post.author.get_full_name|default:post.author.username }}</span>
                    <span class="date">{{ post.created_at|date:"M d, Y" }}</span>
                </div>
            </a>
        </div>
    </header>

    {% if post.image %}
        <figure class="featured-image-container">
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="featured-image">
        </figure>
    {% endif %}

    <main class="main-content">
        <p class="post-summary">{{ post.summary }}</p>
        
        <div class="post-body post-content">
            {{ post_content_html|safe }}
        </div>

        <div class="annotations-section">
            <h3><i class="fas fa-highlighter"></i> Annotations</h3>
            <div id="annotations-list">
                <p class="text-muted">Highlight text in the article to add an annotation.</p>
            </div>
        </div>
    </main>

    <aside class="sidebar">
        {% if related_posts %}
        <div class="sidebar-widget">
            <h4 class="widget-title">More from {{ post.author.username }}</h4>
            <div class="related-posts-list">
                {% for related in related_posts %}
                    <a href="{{ related.get_absolute_url }}" class="related-post-item">
                        {% if related.image %}
                            <img src="{{ related.image.url }}" alt="thumb">
                        {% endif %}
                        <div class="related-info">
                            <h5>{{ related.title }}</h5>
                            <span class="related-date">{{ related.created_at|date:"M d" }}</span>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if post.tags %}
        <div class="sidebar-widget">
            <h4 class="widget-title">Tags</h4>
            <div class="tags-cloud">
                {% for tag in post.get_tags_list %}
                    <span class="tag-chip">#{{ tag }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if post.categories.all %}
        <div class="sidebar-widget">
            <h4 class="widget-title">Topics</h4>
            <div class="category-list">
                {% for cat in post.categories.all %}
                    <a href="{% url 'category_posts' cat.slug %}" class="cat-link">{{ cat.name }}</a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </aside>

    <div class="post-footer-actions">
        <div class="action-group">
            <button class="vote-btn {% if user_vote == 'up' %}active{% endif %}" id="upvote-btn" data-post-slug="{{ post.slug }}" onclick="handleVote('up')">
                <i class="fas fa-arrow-up"></i> <span id="upvote-count">{{ post.get_upvotes }}</span>
            </button>
            <button class="vote-btn {% if user_vote == 'down' %}active{% endif %}" id="downvote-btn" data-post-slug="{{ post.slug }}" onclick="handleVote('down')">
                <i class="fas fa-arrow-down"></i>
            </button>
        </div>

        {% if user == post.author %}
        <div class="action-group author-controls">
            <a href="{% url 'post_edit' post.slug %}" class="btn-manage edit">
                <i class="fas fa-pen"></i> <span>Edit</span>
            </a>
            <a href="{% url 'post_delete' post.slug %}" class="btn-manage delete">
                <i class="fas fa-trash"></i> <span>Delete</span>
            </a>
        </div>
        {% endif %}

        <div class="user-rating-input" data-post-slug="{{ post.slug }}">
            <span>Rate this</span>
            {% for i in "12345" %}
            <i class="far fa-star star-btn" data-value="{{ forloop.counter }}"></i>
            {% endfor %}
        </div>
        
        <div class="action-group right">
            <div class="share-dropdown">
                <button class="share-btn-toggle" title="Share">
                    <i class="fas fa-share-alt"></i>
                </button>
                <div class="share-menu">
                    <a href="#" onclick="sharePost('twitter', '{{ post.slug }}')"><i class="fab fa-twitter"></i> Twitter</a>
                    <a href="#" onclick="sharePost('facebook', '{{ post.slug }}')"><i class="fab fa-facebook"></i> Facebook</a>
                    <a href="#" onclick="sharePost('linkedin', '{{ post.slug }}')"><i class="fab fa-linkedin"></i> LinkedIn</a>
                </div>
            </div>

            <button id="bookmark-btn" 
                    class="{% if user_bookmarked %}bookmarked{% endif %}" 
                    data-post-slug="{{ post.slug }}"
                    title="Bookmark this post">
                <i class="{% if user_bookmarked %}fas{% else %}far{% endif %} fa-bookmark"></i>
            </button>
        </div>
    </div>

    <hr class="section-divider">

    <section class="qna-section">
        <h3><i class="fas fa-question-circle"></i> Q&A with Author</h3>
        <div id="qna-form-container">
            <div class="input-group">
                <input type="text" id="qna-question" class="form-control" placeholder="Ask a question about this post...">
                <button id="qna-submit" class="btn btn-primary">Ask</button>
            </div>
        </div>
        <div id="qna-list" class="mt-4">
            {% for qna in qnas %}
            <div class="qna-item">
                <div class="qna-question">
                    <strong>{{ qna.user.username }}</strong> asked:
                    <div class="mt-1">{{ qna.question }}</div>
                </div>
                
                <div class="mt-2">
                    {% if qna.is_answered %}
                        <div class="qna-answer">
                            <strong>Author:</strong> {{ qna.answer }}
                        </div>
                    {% else %}
                        {% if user == post.author %}
                            <textarea rows="2" class="qna-answer form-control" data-qid="{{ qna.id }}" placeholder="Write your answer..."></textarea>
                            <button class="qna-answer-btn btn btn-sm btn-success mt-2" data-qid="{{ qna.id }}">Submit Answer</button>
                        {% else %}
                            <p class="text-muted"><em>Awaiting author response...</em></p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% empty %}
                <p class="text-muted">No questions yet. Be the first to ask!</p>
            {% endfor %}
        </div>
    </section>

    <hr class="section-divider">

    <section class="comments-section">
        <h3>Comments ({{ comments.paginator.count }})</h3>
        
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'add_comment' post.slug %}" class="comment-form">
                {% csrf_token %}
                {{ comment_form.content }}
                <button type="submit" class="btn btn-primary mt-2">Post Comment</button>
            </form>
        {% else %}
            <p><a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a> to leave a comment.</p>
        {% endif %}

        <div class="comments-list">
            {% for comment in comments %}
                {% include 'blog/includes/comment_item.html' with comment=comment %}
            {% empty %}
                <div class="no-comments">
                    <p>No comments yet. Be the first to start the discussion!</p>
                </div>
            {% endfor %}
        </div>

        {% if comments.has_other_pages %}
        <div class="pagination">
            {% if comments.has_previous %}
                <a href="?page={{ comments.previous_page_number }}" class="page-link">&laquo;</a>
            {% endif %}
            <span class="current">Page {{ comments.number }} of {{ comments.paginator.num_pages }}</span>
            {% if comments.has_next %}
                <a href="?page={{ comments.next_page_number }}" class="page-link">&raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </section>
</div>

<input type="hidden" id="post-slug" value="{{ post.slug }}">
{% if user.is_authenticated %}
<input type="hidden" id="current-username" value="{{ user.username }}">
<input type="hidden" id="current-user-email" value="{{ user.email }}">
{% endif %}
<input type="hidden" id="post-author-email" value="{{ post.author.email }}">
<input type="hidden" id="post-author-username" value="{{ post.author.username }}">

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
</script>
<script>
    // Global variables for existing scripts
    window.postSlug = "{{ post.slug }}";
    window.currentUsername = "{{ user.username }}";
    window.currentUserEmail = "{{ user.email }}";
    window.postAuthorname = "{{ post.author.username }}";
    window.postAuthorEmail = "{{ post.author.email }}";
</script>
<script src="{% static 'blog/js/user_bookmarks.js' %}"></script>
<script src="{% static 'blog/js/annotations.js' %}"></script>
<script src="{% static 'blog/js/qna.js' %}"></script>
<script>
    let timeSpent = 0;
    const slug = "{{ post.slug }}";
    
    setInterval(() => {
        if (document.hasFocus()) {
            timeSpent += 30; // 30 seconds
            fetch(`/post/${slug}/watch-time/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ time: 30 })
            });
        }
    }, 30000); // Ping every 30s

    function handleVote(type) {
        fetch(`/post/${slug}/vote/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `vote_type=${type}`
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                // Reset buttons
                document.getElementById('upvote-btn').classList.remove('active');
                document.getElementById('downvote-btn').classList.remove('active');
                
                // Activate clicked if it wasn't a removal
                if (data.message.includes('recorded')) {
                    document.getElementById(`${type}vote-btn`).classList.add('active');
                }
                if (data.upvote_count !== undefined) {
                    document.getElementById('upvote-count').innerText = data.upvote_count;
                }
            }
        });
    }

    function sharePost(platform, slug) {
        fetch(`/post/${slug}/share/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `platform=${platform}`
        });
        
        // Open actual share window
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent("{{ post.title }}");
        let shareUrl = '';
        if(platform === 'twitter') shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
        if(platform === 'facebook') shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        if(platform === 'linkedin') shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
        
        if(shareUrl) window.open(shareUrl, '_blank', 'width=600,height=400');
    }

    document.querySelectorAll('.star-btn').forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.dataset.value;
            fetch(`/post/${slug}/rate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `rating=${rating}`
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    // Update visual stars
                    document.querySelectorAll('.star-btn').forEach(s => {
                        s.classList.remove('fas');
                        s.classList.add('far');
                        if(s.dataset.value <= rating) {
                            s.classList.remove('far');
                            s.classList.add('fas');
                        }
                    });
                }
            });
        });
    });

    const focusBtn = document.getElementById('focus-mode-toggle');
    const body = document.body;
    focusBtn.addEventListener('click', () => {
        body.classList.toggle('focus-active');
        focusBtn.innerHTML = body.classList.contains('focus-active') ? 
            '<i class="fas fa-compress"></i> <span>Exit Focus</span>' : 
            '<i class="fas fa-expand"></i> <span>Focus Mode</span>';
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

window.postSlug = "{{ post.slug }}";

    // 1. Handle Main Comment Submission
    const mainForm = document.querySelector('.comment-form');
    if (mainForm) {
        mainForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new FormData(form)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    form.reset();
                    const noComments = document.querySelector('.no-comments');
                    if (noComments) noComments.remove();
                    
                    const commentsList = document.querySelector('.comments-list');
                    commentsList.insertAdjacentHTML('afterbegin', data.comment_html);
                } else {
                    alert(data.message);
                }
            })
            .catch(err => console.error(err))
            .finally(() => submitBtn.disabled = false);
        });
    }

    // 2. Moderate (Approve/Reject)
    function moderateComment(commentId, action) {
        fetch(`/post/${window.postSlug}/comment/${commentId}/moderate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `action=${action}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // Replace the specific comment element with the updated HTML from server
                const commentEl = document.getElementById(`comment-${commentId}`);
                if (commentEl && data.comment_html) {
                    commentEl.outerHTML = data.comment_html;
                }
            } else {
                alert(data.message || 'Error moderating comment');
            }
        });
    }

    // 3. Submit Edit
    function submitEdit(event, commentId) {
        event.preventDefault();
        const form = event.target;
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new FormData(form)
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const commentEl = document.getElementById(`comment-${commentId}`);
                if (commentEl && data.comment_html) {
                    commentEl.outerHTML = data.comment_html;
                }
            } else {
                alert(data.message);
            }
        })
        .finally(() => btn.disabled = false);
        return false;
    }

    // 4. Delete Comment
    function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;

        fetch(`/post/${window.postSlug}/comment/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const el = document.getElementById(`comment-${commentId}`);
                if (el) el.remove();
            } else {
                alert(data.message || 'Error deleting comment');
            }
        });
    }

    // 5. Submit Reply
    function submitReply(event, commentId) {
        event.preventDefault();
        const form = event.target;
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new FormData(form)
        })
        .then(res => res.json())
                .then(data => {
            if (data.status === 'success') {
                // Look for the ID we added in the include template
                const repliesList = document.getElementById(`replies-list-${commentId}`);
                
                if (repliesList) {
                    repliesList.insertAdjacentHTML('beforeend', data.comment_html);
                }
                
                form.reset();
                toggleReplyForm(commentId);
            } else {
                alert(data.message);
            }
        })
        .finally(() => btn.disabled = false);
        return false;
    }

    // Helper Functions
    function toggleReplyForm(id) {
        const form = document.getElementById(`reply-form-${id}`);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleEditForm(id) {
        const content = document.getElementById(`comment-content-${id}`);
        const form = document.getElementById(`edit-form-${id}`);
        if (form.style.display === 'none') {
            form.style.display = 'block';
            content.style.display = 'none';
        } else {
            form.style.display = 'none';
            content.style.display = 'block';
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}