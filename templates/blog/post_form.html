{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ form_title|default:"Create New Post" }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <link rel="stylesheet" href="{% static 'blog/css/post_form.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    <h1>{{ form_title|default:"Create New Post" }}</h1>

    {% if form.errors %}
    <div class="alert alert-error" style="background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p style="font-weight: bold; margin-bottom: 0.5rem;">Please correct the following errors:</p>
        <ul style="margin: 0; padding-left: 1.5rem;">
            {% for field in form %}
                {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div id="autosave-indicator" class="autosave-indicator">
        <span id="autosave-text"></span>
    </div>

    <div id="draft-recovery" class="draft-recovery-alert">
        <p>We found an unsaved draft from a previous session.</p>
        <div class="draft-actions">
            <button type="button" onclick="recoverDraft()" class="btn-recover">Recover Draft</button>
            <button type="button" onclick="dismissDraft()" class="btn-dismiss">Discard</button>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="post-form" novalidate>
        {% csrf_token %}

        <div class="form-group">
            <label for="{{ form.title.id_for_label }}">Title</label>
            {{ form.title }}
            <small id="title-count" class="char-count"></small>
            {% if form.title.errors %}
                <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.title.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.slug.id_for_label }}">Slug</label>
            {{ form.slug }}
            <small class="form-help">URL-friendly version of the title.</small>
            <small id="slug-count" class="char-count"></small>
            {% if form.slug.errors %}
                <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.slug.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.image.id_for_label }}">Cover Image</label>
            <div id="image-input" class="file-input-wrapper">
                <label for="{{ form.image.id_for_label }}" class="file-input-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Choose an image or drag and drop</span>
                </label>
                {{ form.image }}
            </div>
            {% if form.image.errors %}
                <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.image.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.summary.id_for_label }}">Summary</label>
            {{ form.summary }}
            <small id="summary-count" class="char-count"></small>
            {% if form.summary.errors %}
                <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.summary.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group editor-wrapper">
            <label for="{{ form.content.id_for_label }}">Content (Markdown Supported)</label>
            {{ form.content }}
            {% if form.content.errors %}
                <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.content.errors.0 }}</div>
            {% endif %}
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="{{ form.categories.id_for_label }}">Categories</label>
                {{ form.categories }}
                {% if form.categories.errors %}
                    <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.categories.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label for="{{ form.tags.id_for_label }}">Tags</label>
                {{ form.tags }}
                <small class="form-help">Comma-separated keywords.</small>
                {% if form.tags.errors %}
                    <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.tags.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label for="{{ form.status.id_for_label }}">Status</label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="error-message" style="color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.status.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{{ submit_text|default:"Publish Post" }}</button>
            <a href="{% url 'post_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    window.titleId = "{{ form.title.auto_id }}";
    window.slugId = "{{ form.slug.auto_id }}";
    window.summaryId = "{{ form.summary.auto_id }}";
    window.contentId = "{{ form.content.auto_id }}";
    window.tagsId = "{{ form.tags.auto_id }}";
    window.statusId = "{{ form.status.auto_id }}";
    window.categoriesId = "{{ form.categories.auto_id }}";
    window.imageId = "{{ form.image.auto_id }}";
    window.draftKey = "blog_post_draft_{% if form.instance.pk %}{{ form.instance.pk }}{% else %}new{% endif %}";
    window.easyMDEPlaceholder = "Write your story here... \n\n# Features\n- **Bold** and *Italic*\n- [Links](https://example.com)\n- Code blocks\n\nUse the toolbar above for formatting and preview.";
</script>
<script src="{% static 'blog/js/post_form.js' %}"></script>
{% endblock %}